<html>
	<head>
		<script type="text/javascript" src="jquery-2.1.4.js"></script>
	</head>
	<body>

	<div id="statsConnection"></div>

	<canvas id="cv"></canvas>


  <select id="username">
    <option value="kevin">kevin</option>
    <option value="travis">josh</option>
    <option value="somebody1">somebody1</option>
  </select>

  <input type="submit" value="Connect" onclick="connect();"/>

	<input type="button" value="U" id="dbgCtrlU"/>
	<input type="button" value="D" id="dbgCtrlD"/>
	<input type="button" value="L" id="dbgCtrlL"/>
	<input type="button" value="R" id="dbgCtrlR"/>

	<script language="javascript">

  var client = null;

  function connect() {
    client = new Client(username.value);
  }


	dbgCtrlU.onclick = function () {
		client.sendjson({
			subject:   'debug-control-move',
			tozone:    true,
			force:     [0.0, 0.0, 1.0, 1.0]
		});
	};

	dbgCtrlD.onclick = function () {
		client.sendjson({
			subject:   'debug-control-move',
			tozone:    true,
			force:     [0.0, 0.0, -1.0, 1.0]
		});
	};

	dbgCtrlL.onclick = function () {
		client.sendjson({
			subject:   'debug-control-move',
			tozone:    true,
			force:     [-1.0, 0.0, 0.0, 1.0]
		});
	};

	dbgCtrlR.onclick = function () {
		client.sendjson({
			subject:   'debug-control-move',
			tozone:    true,
			force:     [1.0, 0.0, 0.0, 1.0]
		});
	};

	function setStatus(msg) {
		$(statsConnection).empty();
		$(statsConnection).append(msg);
	}

  /*
    This is the Client object. You can create an instance of it
    and use it to connect to the server.

    @param string username This is a string that contains the username to login with.
    @param string password This is a string that contains the password to login with.

    @example
      var my_new_client = new Client('kevin', '1234');

    @method sendjson
      @description This will send a raw serialized object to the server. This is the lowest
                   level of communication with the index server.
      @param any obj This is the object that will be JSON serialized and sent to the server.

    @method sendjsontozone
      @description This will send a raw serialized object to the zone server. This is the
                   lowest level of communication to the zone server.
      @param any obj This is the object that will be JSON serialized and sent to the server.
  */
  function Client(username, password) {
    var ws = new WebSocket('ws://localhost:45601');

    this.ws = ws;

    setStatus('Connecting to server..');

    ws.onopen = function (event) {
      ws.sendjson({
        subject:   'login',
        user:      username,
        pass:      password || 'nopassword',
      });
      setStatus('Doing login to index server..');
    };

    ws.sendjson = function (obj) {
      this.send(JSON.stringify(obj));
    };

    /*
      This is a method created on Client. See Client documentation.
    */
    this.sendjson = function (obj) {
      this.ws.sendjson(obj);
    };

    /*
      This is a method created on Client. See Client documentation.
    */
    this.sendjsontozone = function (obj) {
      if (!this.ws.zws) {
        return false;
      }
      this.ws.zws.send(obj);
    };

    var my_uid;
    var my_mid;
    var my_zid;

    ws.onmessage = function (event) {
      var msg = JSON.parse(event.data);
      console.log('message-in', msg);
      switch (msg.subject) {
        /*
          This message means that the index server has changed our zone. We have to comply. It
          may have been an action that the client performed. This is normally sent the first
          time the client enters into the world.

          We simply disconnect from our current zone-host if any, and then connect to the new
          zone-host.
        */
        case 'zone-change':
          my_zid = msg.zid;
          setStatus(['user-id:', my_uid, ' machine-id:', my_mid, ' zone-id:', my_zid, ' zone-address:', msg.address].join(''));

          var zws = new WebSocket(msg.address);

          setStatus('Login ok on index server.. connecting to slave server hosting the zone..');

          if (ws.zws) {
            /*
              Drop the old connection and be nice and let the
              server know so it can go ahead and drop the connection
              without detecting it through the network transport
              layer.

              TODO: It is possible that the server may drop us before we
                    can send this.
            */
            ws.zws.sendjson({
              subject:     'logout'
            });
            ws.zws.close();
          }

          ws.zws = zws;

          var vis_entities = {};

          zws.sendjson = function (obj) {
            ws.send(JSON.stringify(obj));
          };

          zws.onopen = function (event) {
            setStatus(['user-id:', my_uid, ' machine-id:', my_mid, ' zone-id:', my_zid, ' zone-address:', msg.address, ' INDEX-FEED-GOOD ZONE-FEED-GOOD'].join(''));
            console.log('got zone channel open');
          };

          zws.onmessage = function (event) {
            var msg = JSON.parse(event.data);
            console.log('msg', msg);
            switch (msg.subject) {
              /*
                This _may_ happen when we enter a portal for example, or the zone-host may use this to
                force us onto a different zone-host. We should comply with this command, because the
                zone-host is able to drop our connection after this message.
              */
              case 'zone-changed':
                // TODO: implement
                break;
              case 'entity-entered':
                vis_entities[msg.eid] = {
                  label:     msg.label,
                  x:         0.0,
                  y:         0.0,
                  z:         0.0
                };
                break;
              case 'entity-left':
                delete vis_entities[msg.eid];
                break;
              case 'entity-absolute-position-update':
                var eid = msg.eid;
                var e = vis_entities[eid];

                e.x = msg.x;
                e.y = msg.y;
                e.z = msg.z;

                var ctx = cv.getContext('2d');

                ctx.fillRect(msg.x, msg.y, 10, 10);
                ctx.fillText(msg.x, msg.y, e.label);
                break;
            }

          };

          zws.onerror = function (event) {
            setStatus('Index login GOOD, but ERROR connecting to the zone host on slave at ' + msg.address);
          };
          break;
        case 'login-accepted':
          my_uid = msg.uid;
          my_mid = msg.mid;
          setStatus(['user-id:', my_uid, ' machine-id:', my_mid, ' zone-id: <waiting>'].join(''));
          break;
      }
    }
  }
	</script>
	</body>
</html>
